<?xml version="1.0" encoding="UTF-8"?>
<document signature="Hero Lab Data">
  <loadonce key="PF_Spheres_DDS - Errata"/>
  <fileinfo>
    <info_author>(C) James Risner, 2023-2025
BSD-2-Clause license</info_author>
    </fileinfo>
  <thing id="cSoPConvinR" name="Convincing" compset="ClSpecial" description="At 9th level, an eliciter may take 10 with any Bluff, Diplomacy, Intimidate, or Sense Motive check if he has ranks in that skill, even if circumstances would normally prohibit this action.\n\nIn addition, once per day the eliciter may choose to take 20 on one of these skill checks without taking additional time. He may use this ability twice per day at 13th level, and three times per day at 17th level." summary="You can always take 10 with social skills." replaces="cSoPConvin">
    <fieldval field="trkMax" value="1"/>
    <tag group="AbilType" tag="Extra"/>
    <tag group="ProductId" tag="DropDead"/>
    <tag group="SpecType" tag="Skill"/>
    <tag group="Usage" tag="Day"/>
    <tag group="User" tag="Tracker"/>
    <eval phase="PostLevel" priority="10000"><![CDATA[doneif (tagis[Helper.SpcDisable] = 0)

     ~ Add uses/day from levels
     if (field[xAllLev].value >= 13) then
       field[trkMax].value += 1
     endif
     if (field[xAllLev].value >= 17) then
       field[trkMax].value += 1
     endif]]></eval>
    <eval phase="Render" priority="10000" index="2"><![CDATA[doneif (tagis[Helper.SpcDisable] = 0)
      var desc as string
      desc = "You can always take 10 with this skill, even if circumstances would normally prohibit that action."
      #situational[hero.childfound[skBluff],desc,field[thingname].text]
      #situational[hero.childfound[skDiplo],desc,field[thingname].text]
      #situational[hero.childfound[skIntim],desc,field[thingname].text]
      #situational[hero.childfound[skSenseMot],desc,field[thingname].text]
      field[abSumm].text = "You can always take 10 with social skills, and take 20 without spending more time " & field[trkMax].value & tagnames[Usage.?]]]></eval>
    </thing>
  <thing id="PMErrata" name="Power and Might Errata" compset="Mechanics" description="Errata for the released SoM v1.23, USoP v1.42, and CotS v1.52" uniqueness="unique">
    <usesource source="pPF1e_Sph_Errat"/>
    <eval phase="First" priority="100"><![CDATA[
       doneif (hero.tagis[source.pPF1e_Sph_Errat] = 0)

       ~ For Incanter's tHelpInc thing, the first level index=0 was omitted.
       perform hero.childfound[tHelpInc].setfocus
       if (state.isfocus <> 0) then
         ~ The Incanter gains 1 magic talent at 1st level.
         focus.field[cTalKnown].arrayvalue[0] = 1
         perform state.clearfocus
       endif

       ~bonus spells issue debug messages "Class can't (take/memorize) spells"
       perform hero.childfound[arSPSphSor].setfocus
       if (state.isfocus <> 0) then
         ~ find all the bonus spells that were added by our bloodlines, and
         ~ hide them
         foreach pick in hero from BaseSpell where "SpellType.cHelpSor & BonusSplAt.?"
           perform eachpick.assign[Hide.Spell]
           ~ This prevents "Class can't (take|memorise) spells????" errors.
           perform eachpick.assign[Helper.SplNotPrep]
         nexteach
       endif

       ~Undead Servants misspells Knowledge (religion) thingid.
       if (hero.tagis[source.pSoMLead] <> 0) then
         var undead as string
         undead = "thingid.somDbUndeadSer"
         perform hero.findchild[SoMDrawbk,undead].setfocus
         if (state.isfocus <> 0) then
           if (focus.tagis[ClassSkill.skKnowRe] <> 0) then
             perform focus.delete[ClassSkill.skKnowRe]
             perform focus.assign[ClassSkill.skKnowRel]
           endif
         endif
       endif

       ~ Additional errata planned to be incorporate:
       ~ arSoPWendigo
       ~ arChSpDimDefe
       ~ somTlBashShield
       ~ sopTlWpEmT
       ~ somTlVersaShield
       ~ somDbSavageCombat
       ~ cSoMSkilledCrafts
       ~ Timing issue with Shield Expert = somTlRShieldExper
       ~ Timing issue with Tower Shield Mastery = somTlRiTowerShdMa

     ]]></eval>
    <eval phase="PostAttr" priority="50001" name="Correct SoP redundant talents"><![CDATA[
     doneif (hero.tagis[source.pPF1e_Sph_Errat] = 0)

     var ct as number
     var tot as number
     var sp as string
     foreach pick in hero from SoPSphere where "SoPSphere.?"
        ct = 0
        tot = 0
        sp = eachpick.tagids[SoPSphere.?]
        foreach pick in hero from SoPTalent where sp & " & SphOfPow.Talent & SoPTlClass.GainSphere & (SoPDupBon.? | SphOfPow.DupeBonTal)"
           var dupes as number
           if (eachpick.isunique = 1) then
              dupes = eachpick.uniqcount - 1
           elseif (eachpick.tagis[thing.useronce] = 1) then
              if (eachpick.tagis[Helper.FirstCopy] = 0) then
                 dupes = eachpick.field[tTaken].value - 1
              endif
           endif

           if (dupes > 1) then
              ct += 1
              tot += dupes
           endif
        nexteach
        if (ct > 0) then
           dupes = tot / ct
           perform hero.findchild[Resource, replace(sp,"SoPSphere.","SoPBonTal.",0)].setfocus
           if (state.isfocus = 1) then
              ~ A bug in Spheres of Power adds extra for each duplicate instead
              ~ of just adding +1 for each duplicate, this deducts.
              focus.field[resMax].value -= (tot - dupes)
           endif
        endif
     nexteach
     ]]></eval>
    </thing>
  </document>
